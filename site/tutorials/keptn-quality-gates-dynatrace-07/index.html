
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Keptn Quality Gates with Dynatrace</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-133584243-1"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="keptn-quality-gates-dynatrace-07"
                  title="Keptn Quality Gates with Dynatrace"
                  environment="web"
                  feedback-link="https://github.com/keptn/tutorials/tree/master/site/tutorials">
    
      <google-codelab-step label="Welcome" duration="5">
        <p>If you have tools that deploy your applications and then run tests against those you have done the hard work already. <em>Keptn&#39;s Quality Gates</em> help you to automate the evaluation of your test results and the monitoring data captured during your tests. Keptn does this by embracing the concept of Service Level Indicators (SLIs) and Service Level Objectives (SLOs). Essentially SLIs are metrics such as Response Time, Throughput, Error Rate, Number of Database Calls, Time spent in external service calls, ... and SLOs define which objective you have for these SLIs to consider your service to be adhering to what you expect, e.g: Response Time of Login should be faster than 200ms or Login should not make more than 1 database query.<br>Keptn didn&#39;t come up with these concepts. They have been around for a while and made very popular thanks to the work that Google did around <a href="https://landing.google.com/sre/sre-book/chapters/service-level-objectives" target="_blank">Site Reliability Engineering</a></p>
<p>In this tutorial we teach you how you can use Keptn Quality Gates to automatically analyze important metrics (SLIs) that Dynatrace captures while your system is under load, e.g: during a load test and compare them against your expected behavior (SLOs). This comparison can either be against well defined thresholds, e.g: 200ms response time but can also be a comparison against previous test results, e.g: response time should not get slower than 10% of our previous build.</p>
<p>The real benefit is visulized in the following animation. Keptn Quality Gates help you automate the manual task of analyzing or comparing data on dashboards to determine whether a build meets your quality criteria.</p>
<p class="image-container"><img src="img/7c651a5eb1b5f93a.gif"></p>
<p>This tutorial will use a simple node.js based containerized sample application which you will deploy</p>
<h2 class="checklist" is-upgraded>What you&#39;ll learn</h2>
<ul class="checklist">
<li>Install Keptn and setup a Keptn Project for Quality Gate evaluation</li>
<li>Prepare Dynatrace to act as a data source for Quality Gate evaluation</li>
<li>Learn how to define and use service-level indicators (SLIs) and service-level objectives (SLOs)</li>
<li>How to trigger a Keptn Quality Gate evaluation using the CLI and the API</li>
<li>How to use the Keptns Bridge to inspect your Quality Gate Results</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Keptn Quality Gates for Dynatrace Users in 5 Minutes" duration="0">
        <p>We have invested in a new easier way to test and explore Keptn Quality Gates and are in progress of updating this tutorial accordingly.<br>If you want to give the new <a href="https://github.com/keptn-sandbox/keptn-on-k3s/blob/master/README-KeptnForDynatrace.md" target="_blank">Keptn Quality Gates for Dynatrace User in 5 Minutes</a> it a try please continue <a href="https://github.com/keptn-sandbox/keptn-on-k3s/blob/master/README-KeptnForDynatrace.md" target="_blank">here</a>. Its a full tutorial that lives on GitHub in the moment. We will move it over to this tutorial page - but - as of today - feel free to simply follow the steps over on the GitHub page.</p>
<p>Once you install Keptn based on the installation instructions you will automatically get a pre-configured quality gate project connected to your Dynatrace Environment which is ready to run quality gates:<br><img src="img/baf8012571e7d2a2.png"></p>
<p>This tutorial already uses the new Dynatrace SLO Dashboard capabilities which pull data from a dashboard that looks like this:<br><img src="img/54e0a809a6ae2604.png"></p>
<p>To summarize - here is why you should run the <a href="https://github.com/keptn-sandbox/keptn-on-k3s/blob/master/README-KeptnForDynatrace.md" target="_blank">GitHub tutorial</a>:</p>
<ul>
<li>You only need a Linux machine with 4GB RAM &amp; 1vCPU to setup keptn</li>
<li>You can explore to the Dynatrace SLO dashboard capability of Keptn</li>
<li>You can immediately run your quality after the installation completes</li>
</ul>
<p>If you want to continue with the existing tutorial feel free to do so. Then just continue with the next steps!</p>


      </google-codelab-step>
    
      <google-codelab-step label="Prerequisites Keptn" duration="5">
        <p>Before you can get started, please make sure to have Keptn installed on your Kubernetes cluster.</p>
<p>If not, please <a href="../../?cat=installation" target="_blank">follow one of these tutorials to install Keptn</a> on your favourite Kubernetes distribution. You can either do a full Keptn installation or can opt in to only install the execution plane for quality-gates by adding â€“use-case=quality-gates to keptn install. Both installation options will work for our tutorial.</p>
<p>What you need in order to complete this tutorial is<br>1: keptn status needs to successfully connect to your keptn instance<br>2: kubectl needs to be configured to connect to your k8s cluster<br>3: you have access to the Keptns Bridge. If you have not yet exposed it please do so as described in <a href="https://keptn.sh/docs/0.6.0/reference/keptnsbridge/#expose-lockdown-bridge" target="_blank">Expose Keptn&#39;s Bridge</a></p>


      </google-codelab-step>
    
      <google-codelab-step label="Prerequisites Dynatrace &amp; Sample application" duration="5">
        <p>This tutorial assumes that you have an application that is already deployed and monitored with Dynatrace. It should also be an application that has some load on it in order for Keptn to pull metrics for the SLI/SLO-based Quality Gate evaluation.<br>If you do not have an application that is under load follow the next tutorial step. Otherwise you can skip it:</p>


      </google-codelab-step>
    
      <google-codelab-step label="Monitor, Deploy and Run Load against Simplenode" duration="5">
        <p>In our tutorial we are not using Keptn for deploying our application. The goal is to show you that Keptn can also be used for Quality Gates or even Performance Evaluation on applications deployed manually or through other deployment automation tools.</p>
<p>We do however need an application that is monitored by Dynatrace in order for Keptn to pull out metrics during the evaluation.</p>
<p>In case you do not have your own application and the tutorial offered you to deploy this simple node.js-based sample application then follow these steps to deploy it and get it monitored by Dynatrace.</p>
<h2 is-upgraded>Host monitored with Dynatrace</h2>
<p>Before we deploy our application lets make sure that your host is monitored with Dynatrace. To accomplish that make sure that you install the <a href="https://www.dynatrace.com/support/help/setup-and-configuration/dynatrace-oneagent/" target="_blank">Dynatrace OneAgent</a> on your host where you will be deploying our application later on. One option is to standup a virtual machine on your favorite cloud vendor. and either add the installation instructions of the OneAgent to the startup script or execute it once the machine is running. The end goal should be that Dynatrace is monitoring that host:</p>
<p class="image-container"><img src="img/810a7d244cd64b9.png"></p>
<p>Another option would be to deploy that application on a Kubernetes cluster. In that case please follow the instructions to <a href="https://www.dynatrace.com/support/help/technology-support/cloud-platforms/kubernetes/" target="_blank">deploy the Dynatrace OneAgent on Kubernetes</a></p>
<h2 is-upgraded>Deploy the sample app</h2>
<p>Now as we have Dynatrace monitor your host we can deploy our container. Here is the example on how to deploy it using docker:</p>
<pre><code>docker run -p 80:8080 grabnerandi/simplenodeservice:1.0.0
</code></pre>
<p>This will deploy Build 1.0.0 of the simplenodeservice sample application and exposing it via port 80. If you have your firewalls setup correctly you should be able to navigate to the website as well as shortly after seeing the SimpleNodeJsService show up in Dynatrace:<br><img src="img/cfb126dbbd7d69b2.png"></p>
<h2 is-upgraded>Put some load on it</h2>
<p>Last what we need is some consistent load on the service so that later on when asking Keptn to evaluate SLIs against our SLOs Dynatrace has data for that time period.<br>The examples repository from Git that you have cloned locally contains two options<br>1: Running JMeter<br>If you happen to have JMeter installed you can run the load.jmx script (from examples/simplenodeservice/keptn/jmeter). Before you do please change the SERVER_URL variable to the URL of your hosted version of the simplenode application. Additionally you should also change the ThreadGroups Loop Count setting to forever so that the test keeps running!</p>
<p>2: Run a batch with CURL<br>Another option is to launch the gen_load.sh file you will find under examples/simplenodeservice/helpers. This script uses curl to execute some simple GET requests. It will run until you either kill the process or until the script finds the file endloadtest.txt (which can be empty).</p>
<p>To validate if load comes through navigate to the service in Dynatrace and validate that you see performance &amp; trace data for your monitored service!</p>


      </google-codelab-step>
    
      <google-codelab-step label="Setup Dynatrace" duration="7">
        <p>For enabling the Keptn Quality Gates and for production monitoring, we are going to use Dynatrace as the data provider. Therefore, we are going to setup Dynatrace in our Kubernetes cluster to have our sample application monitored and we can use the monitoring data for both the basis for evaluating quality gates as well as a trigger to start self-healing.</p>
<aside class="special"><p>You have to bring your own Dynatrace tenant</p>
</aside>
<p>If you don&#39;t have a Dynatrace tenant yet, sign up for a <a href="https://www.dynatrace.com/trial/" target="_blank">free trial</a> or a <a href="https://www.dynatrace.com/developer/" target="_blank">developer account</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Gather Dynatrace tokens" duration="6">
        <ol type="1">
<li>Create a Dynatrace API TokenLog in to your Dynatrace tenant and go to <strong>Settings &gt; Integration &gt; Dynatrace API</strong>. Then, create a new API token with the following permissions:<ul>
<li>Access problem and event feed, metrics, and topology</li>
<li>Read log content</li>
<li>Read configuration</li>
<li>Write configuration</li>
<li>Capture request data</li>
<li>Read metrics</li>
<li>Ingest metrics</li>
<li>Read entities</li>
</ul>
Take a look at this screenshot to double check the right token permissions for you.<img alt="Dynatrace API Token" src="img/5052ffbd6ab534f1.png"></li>
<li>Create a Dynatrace PaaS TokenIn your Dynatrace tenant, go to <strong>Settings &gt; Integration &gt; Platform as a Service</strong>, and create a new PaaS Token.</li>
<li>Store your credentials in a Kubernetes secret by executing the following command. The <code>DT_TENANT</code> has to be set according to the appropriate pattern:<ul>
<li>Dynatrace SaaS tenant (this format is most likely for you): <code>{your-environment-id}.live.dynatrace.com</code></li>
<li>Dynatrace-managed tenant: <code>{your-domain}/e/{your-environment-id}</code></li>
</ul>
If running on a Unix/Linux based system, you can use variables for ease of use. Naturally, it is also fine to just replace the values in the <code>kubectl</code> command itself.<pre><code>export DT_TENANT=yourtenant.live.dynatrace.com
export DT_API_TOKEN=yourAPItoken
export DT_PAAS_TOKEN=yourPAAStoken
</code></pre>
<aside class="warning"><p>Please make sure your DT_TENANT does <em>not contain</em> any trailing slashes nor a https:// in the beginning.</p>
</aside>
If you used the variables, the next command can be copied and pasted without modifications. If you have not set the variables, please make sure to set the right values in the next command.<pre><code>kubectl -n keptn create secret generic dynatrace --from-literal=&#34;DT_TENANT=$DT_TENANT&#34; --from-literal=&#34;DT_API_TOKEN=$DT_API_TOKEN&#34;  --from-literal=&#34;DT_PAAS_TOKEN=$DT_PAAS_TOKEN&#34; --from-literal=&#34;KEPTN_API_URL=http://$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath=&#39;{.spec.rules[0].host}&#39;)/api&#34; --from-literal=&#34;KEPTN_API_TOKEN=$(kubectl get secret keptn-api-token -n keptn -ojsonpath=&#39;{.data.keptn-api-token}&#39; | base64 --decode)&#34; --from-literal=&#34;KEPTN_BRIDGE_URL=http://$(kubectl -n keptn get ingress api-keptn-ingress -ojsonpath=&#39;{.spec.rules[0].host}&#39;)/bridge&#34; 
</code></pre>
</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Deploy Dynatrace OneAgent Operator" duration="0">
        <p>To make the tutorial experience as smooth as possible, we are providing an automation script to setup the Dynatrace OneAgent operator in your Kubernetes cluster. For details on the installation, we refer to the <a href="https://www.dynatrace.com/support/help/technology-support/cloud-platforms/kubernetes/deploy-oneagent-k8/" target="_blank">official Dynatrace documentation</a>. You can download and run the script using the following instructions.</p>
<ol type="1">
<li>Downloading the automation file.<pre><code>curl -o deploy-dynatrace-oneagent.sh https://raw.githubusercontent.com/keptn/examples/release-0.7.0/dynatrace-oneagent/deploy-dynatrace-oneagent.sh
</code></pre>
</li>
<li>Making the file executable using the <code>chmod</code> command.<pre><code>chmod +x deploy-dynatrace-oneagent.sh
</code></pre>
</li>
<li>Executing the script to automatically deploys the Dynatrace OneAgent Operator.<pre><code>./deploy-dynatrace-oneagent.sh
</code></pre>
</li>
<li>Optional: Verify if all pods in the Dynatrace namespace are running. It might take up to 1-2 minutes for all pods to be up and running.<pre><code>kubectl get pods -n dynatrace
</code></pre>
<pre><code>dynatrace-oneagent-operator-696fd89b76-n9d9n   1/1     Running   0          6m26s
dynatrace-oneagent-webhook-78b6d99c85-h9759    2/2     Running   0          6m25s
oneagent-g9m42                                 1/1     Running   0          69s
</code></pre>
</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="Install Dynatrace integration" duration="5">
        <ol type="1">
<li>The Dynatrace integration into Keptn is handled by the <em>dynatrace-service</em>. To install the <em>dynatrace-service</em>, execute:<pre><code>kubectl apply -f https://raw.githubusercontent.com/keptn-contrib/dynatrace-service/release-0.10.0/deploy/service.yaml -n keptn
</code></pre>
</li>
<li>When the service is deployed, use the following command to install Dynatrace on your cluster. If Dynatrace is already deployed, the current deployment of Dynatrace will not be modified.<pre><code>keptn configure monitoring dynatrace
</code></pre>
Output should be similar to this:<pre><code>ID of Keptn context: 79f19c36-b718-4bb6-88d5-cb79f163289b
Configuring Dynatrace monitoring
Dynatrace OneAgent Operator is installed on cluster
Setting up auto-tagging rules in Dynatrace Tenant
Tagging rule keptn_service already exists
Tagging rule keptn_stage already exists
Tagging rule keptn_project already exists
Tagging rule keptn_deployment already exists
Setting up problem notifications in Dynatrace Tenant
Checking Keptn alerting profile availability
Keptn alerting profile available
Dynatrace Monitoring setup done
</code></pre>
</li>
</ol>
<p><strong>Verify Dynatrace configuration</strong></p>
<p>Since Keptn has configured your Dynatrace tenant, let us take a look what has be done for you:</p>
<ul>
<li><em>Tagging rules:</em> When you navigate to <strong>Settings &gt; Tags &gt; Automatically applied tags</strong> in your Dynatrace tenant, you will find following tagging rules:<ul>
<li>keptn_deployment</li>
<li>keptn_project</li>
<li>keptn_service</li>
<li>keptn_stage<br><br></li>
</ul>
This means that Dynatrace will automatically apply tags to your onboarded services.</li>
<li><em>Problem notification:</em> A problem notification has been set up to inform Keptn of any problems with your services to allow auto-remediation. You can check the problem notification by navigating to <strong>Settings &gt; Integration &gt; Problem notifications</strong> and you will find a <strong>keptn remediation</strong> problem notification.</li>
<li><em>Alerting profile:</em> An alerting profile with all problems set to <em>0 minutes</em> (immediate) is created. You can review this profile by navigating to <strong>Settings &gt; Alerting &gt; Alerting profiles</strong>.</li>
<li><em>Dashboard and Mangement zone:</em> When creating a new Keptn project or executing the <a href="https://keptn.sh/docs/0.6.0/reference/cli/commands/keptn_configure_monitoring/" target="_blank">keptn configure monitoring</a> command for a particular project (see Note 1), a dashboard and management zone will be generated reflecting the environment as specified in the shipyard file.</li>
</ul>
<aside class="warning"><p>If the nodes in your cluster run on <em>Container-Optimized OS (cos)</em> (default for GKE), the Dynatrace OneAgent might not work properly, the next steps are necessary.</p>
</aside>
<p>Follow the next steps only if your Dynatrace OneAgent does not work properly.</p>
<ol type="1">
<li>To check if the OneAgent does not work properly, the output of <code>kubectl get pods -n dynatrace</code> might look as follows:<pre><code>NAME                                           READY   STATUS             RESTARTS   AGE
dynatrace-oneagent-operator-7f477bf78d-dgwb6   1/1     Running            0          8m21s
oneagent-b22m4                                 0/1     Error              6          8m15s
oneagent-k7jn6                                 0/1     CrashLoopBackOff   6          8m15s
</code></pre>
</li>
<li>This means that after the initial setup you need to edit the OneAgent custom resource in the Dynatrace namespace and add the following entry to the env section:<pre><code>env:
- name: ONEAGENT_ENABLE_VOLUME_STORAGE
  value: &#34;true&#34;
</code></pre>
</li>
<li>To edit the OneAgent custom resource:<pre><code>kubectl edit oneagent -n dynatrace
</code></pre>
</li>
</ol>
<p>At the end of your installation, please verify that all Dynatrace resources are in a Ready and Running status by executing <code>kubectl get pods -n dynatrace</code>:</p>
<pre><code>NAME                                           READY   STATUS       RESTARTS   AGE
dynatrace-oneagent-operator-7f477bf78d-dgwb6   1/1     Running      0          8m21s
oneagent-b22m4                                 1/1     Running      0          8m21s
oneagent-k7jn6                                 1/1     Running      0          8m21s
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Create a Keptn Quality Gate Project" duration="2">
        <p>A project in Keptn is the logical unit that can hold multiple (micro)services. Therefore, it is the starting point for each Keptn installation.</p>
<p>To get all files you need for this tutorial, please clone the example repo to your local machine.</p>
<pre><code>git clone --branch release-0.7.0 https://github.com/keptn/examples.git --single-branch

cd examples/simplenodeservicequality-gate-only
</code></pre>
<p>For this quality gate focused tutorial we will create a new Keptn project using <code>keptn create project</code> to create a project called <em>qgproject</em> using the shipyard_qualitystageonly.yaml as a shipyard definition.<br>Before executing the following command, make sure you are in the <code>examples/simplenodeservicequality-gate-only</code> folder.<br>Please note that <a href="https://keptn.sh/docs/0.7.x/manage/project/#select-git-based-upstream" target="_blank">defining a Git upstream</a> is recommended, but in case that is not wanted the parameters <code>git-user</code>, <code>git-token</code> and <code>git-remote-url</code> can be omitted.</p>
<pre><code>keptn create project qgproject --shipyard=./shipyard_qualitystageonly.yaml --git-user=GIT_USER --git-token=GIT_TOKEN --git-remote-url=GIT_REMOTE_URL
</code></pre>
<p>For our purpose we create a simple project with a single stage called <strong>qualitystage</strong> as we only use Keptn for quality gate evaluations instead of using Keptn for multi-stage delivery pipelines. The content of this shipyard file is rather simple:</p>
<pre><code>stages:
  - name: &#34;qualitystage&#34;
</code></pre>
<p>Later - as we onboard services - we will be able to use this qualitystage to let Keptn evaluate our SLI/SLO based quality gates!</p>
<aside class="special"><p>To learn more about a <em>shipyard</em> file, please take a look at the <a href="https://github.com/keptn/spec/blob/master/shipyard.md" target="_blank">Shipyard specification</a>.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Add our microservice to our project" duration="2">
        <p>After creating a Keptn project, services can be added. If we want to use Keptn for Progressive Delivery where Keptn deploys our service using Helm we can use <code>keptn onboard service</code>. In the case where Keptn doesn&#39;t do the deployment but is used for Quality Gate or Performance Evaluation we use the command <a href="https://keptn.sh/docs/0.7.x/reference/cli/commands/keptn_create_service/" target="_blank">keptn create service</a>:</p>
<pre><code>keptn create service evalservice --project=qgproject
</code></pre>
<p>This command just created a service we call <em>evalservice</em> and we added it to our <em>qgproject</em></p>
<p>We can validate that this service was added by opening up Keptn&#39;s bridge and navigate to the <em>qgproject</em>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Setup SLI provider" duration="2">
        <p>During the evaluation of a quality gate, the Dynatrace SLI provider is required that is implemented by an internal Keptn service, the dynatrace-sli-service. This service will fetch the values for the SLIs that are referenced in an SLO configuration.</p>
<pre><code>kubectl apply -f https://raw.githubusercontent.com/keptn-contrib/dynatrace-sli-service/release-0.7.1/deploy/service.yaml -n keptn
</code></pre>
<p>Configure the already onboarded project with the new SLI provider:</p>
<pre><code>keptn configure monitoring dynatrace --project=qgproject
</code></pre>
<aside class="special"><p>Since we already installed the Dynatrace service, the SLI provider can fetch the credentials to connect to Dynatrace from the same secret we created earlier.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Tag service for quality gate evaluation" duration="2">
        <p>Whether you are using our sample application or your own application, in order for the quality gate evaluation to work we need to properly tag the service. This is important as SLI (Service Level Indicators) will be queried from Dynatrace only from entities that match a certain tag. In our case it will add a tag that matches the name of of the Keptn Service which is <em>evalservice</em>. In Dynatrace there are multiple options to put a tag on a service:</p>
<ul>
<li><a href="https://www.dynatrace.com/support/help/how-to-use-dynatrace/tags-and-metadata/setup/how-to-define-tags/" target="_blank">Manual Tagging</a>: put them on service and the process group via the UI or the Dynatrace API</li>
<li><a href="https://www.dynatrace.com/support/help/how-to-use-dynatrace/tags-and-metadata/setup/how-to-define-tags/" target="_blank">Automated Tagging</a>: define a rule that tag entities based on existing meta data</li>
<li>Cloud &amp; Platform Tags: extract tags &amp; annotations from <a href="https://www.dynatrace.com/support/help/technology-support/cloud-platforms/kubernetes/other-deployments-and-configurations/leverage-tags-defined-in-kubernetes-deployments/" target="_blank">k8s</a>, <a href="https://www.dynatrace.com/support/help/technology-support/cloud-platforms/openshift/other-deployments-and-configurations/leverage-tags-defined-in-openshift-deployments/" target="_blank">OpenShift</a> or <a href="https://www.dynatrace.com/support/help/technology-support/cloud-platforms/cloud-foundry/other-deployments-and-configurations/leverage-tags-defined-in-cloud-foundry-deployments/" target="_blank">Cloud Foundry</a></li>
<li><a href="https://www.dynatrace.com/support/help/how-to-use-dynatrace/tags-and-metadata/setup/define-tags-based-on-environment-variables/" target="_blank">Environment Tags</a>: specify tags via the DT_TAGS environment variable</li>
</ul>
<p>In our example we simply go the manual tagging route which means we simply add a tag called <em>evalservice</em> to the deployed service via the Dynatrace UI like shown below:<br><img src="img/2a120062a4ff0419.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Set up a basic quality gate for evalservice" duration="4">
        <p>Keptn Quality Gates are based on the concepts of</p>
<ul>
<li>SLIs (Service Level Indicators): what metrics (=indicators) are important and how do we query them</li>
<li>SLOs (Service Level Objectives): what conditions (=objectives) must be met to consider this a good or a bad value per indicator</li>
</ul>
<p>In Keptn we therefore need to provide an <code>sli.yaml</code> that defines how to query certain metrics from a specific tool, e.g: Dynatrace. We also need to provide an <code>slo.yaml</code> that defines the conditions - this file is tool independant.<br>To learn more about the <em>sli.yaml</em> and <em>slo.yaml</em> files, go to <a href="https://github.com/keptn/spec/blob/0.1.3/sre.md" target="_blank">Specifications for Site Reliability Engineering with Keptn</a>.</p>
<p>Our example comes with a basic and an extended set of SLIs and SLOs. In this step we focus on the basic version.<br>We have to upload two files using the <a href="https://keptn.sh/docs/0.7.x/reference/cli/#keptn-add-resource" target="_blank">add-resource</a> command.<br>Ensure you navigate to the <code>examples/simplenodeservice/quality-gate-only</code> folder.</p>
<ol type="1">
<li>First, lets upload our <code>dynatrace/sli_basic.yaml</code> as <code>dynatrace/sli.yaml</code>!<pre><code>keptn add-resource --project=qgproject --stage=qualitystage --service=evalservice --resource=dynatrace/sli_basic.yaml --resourceUri=dynatrace/sli.yaml
</code></pre>
</li>
</ol>
<p>This Dynatrace specific SLI contains the definition of 5 indicators. Each indicator has a logical name, e.g: throughput and the tool specific query, e.g: Dynatrace Metrics Query. You can also see that the query definition can leverage placeholders such as $SERVICE (there are more of course). In our case - because we keep it really simply we only use the $SERVICE placeholder telling Keptn to only query data from those SERVICE entities that have a tag applied with the name of our Keptn Service. This will be <em>evalservice</em>:</p>
<pre><code>---
spec_version: &#39;1.0&#39;
indicators:
  throughput_svc: &#34;metricSelector=builtin:service.requestCount.total:merge(0):sum&amp;entitySelector=tag($SERVICE),type(SERVICE)&#34;
  error_rate_svc: &#34;metricSelector=builtin:service.errors.total.rate:merge(0):avg&amp;entitySelector=tag($SERVICE),type(SERVICE)&#34;
  rt_svc_p50:     &#34;metricSelector=builtin:service.response.time:merge(0):percentile(50)&amp;entitySelector=tag($SERVICE),type(SERVICE)&#34;
  rt_svc_p90:     &#34;metricSelector=builtin:service.response.time:merge(0):percentile(90)&amp;entitySelector=tag($SERVICE),type(SERVICE)&#34;
  rt_svc_p95:     &#34;metricSelector=builtin:service.response.time:merge(0):percentile(95)&amp;entitySelector=tag($SERVICE),type(SERVICE)&#34;
</code></pre>
<ol type="1">
<li>Second, lets upload our <code>slo_basic.yaml</code> as <code>slo.yaml</code><pre><code>keptn add-resource --project=qgproject --stage=qualitystage --service=evalservice --resource=slo_basic.yaml --resourceUri=slo.yaml
</code></pre>
</li>
</ol>
<p>This <code>slo.yaml</code> defines the objectives and references the SLIs defined in the <code>sli.yaml</code>:</p>
<pre><code>---
spec_version: &#39;0.1.0&#39;
comparison:
  compare_with: &#34;single_result&#34;
  include_result_with_score: &#34;pass&#34;
  aggregate_function: avg
objectives:
  - sli: response_time_p95
    pass:        # pass if (relative change &lt;= 10% AND absolute value is &lt; 500)
      - criteria:
          - &#34;&lt;=+10%&#34; # relative values require a prefixed sign (plus or minus)
          - &#34;&lt;600&#34;   # absolute values only require a logical operator
    warning:     # if the response time is below 800ms, the result should be a warning
      - criteria:
          - &#34;&lt;=800&#34;
  - sli: throughput
    pass:
      - criteria:
        - &#34;&gt;4000&#34;
  - sli: error_rate
    weight: 2
    pass:
      - criteria:
          - &#34;&lt;=1%&#34;
    warning:
      - criteria:
          - &#34;&lt;=2%&#34;
  - sli: response_time_p50
  - sli: response_time_p90
    pass:
      - criteria:
          - &#34;&lt;=+10%&#34;
    warning:
      - criteria:
          - &#34;&lt;=+10%&#34;
total_score:
  pass: &#34;90%&#34;
  warning: &#34;75%&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Dynatrace Event Configuration" duration="1">
        <p>Keptn not only provides an integration with Dynatrace to pull SLIs. It also provides an integration where Keptn can push events to Dynatrace, e.g: when a Quality Gate was evaluated it can send that information to a specific set of Dynatrace entities by leveraging the Dynatrace Events API.<br>By default the Dynatrace Keptn Service assumes that monitored services in Dynatrace are deployed by Keptn and therefore tagged with 4 specific tags: keptn_project, keptn_service, keptn_stage &amp; keptn_deployment. In a scenario where Keptn doesnt manage the deployment we cannot assume these tags are there. This is why we have to tell the Dynatrace Keptn Service to which entities the events should be sent to. This configuration can be provided by uploading a <em>dynatrace.conf.yaml</em> which includes the actual tag rules. In our case its very simply. First the command to upload the dynatrace.conf.yaml:</p>
<pre><code>keptn add-resource --project=qgproject --stage=qualitystage --service=evalservice --resource=dynatrace/dynatrace.conf.yaml --resourceUri=dynatrace/dynatrace.conf.yaml
</code></pre>
<p>And here is the content that is in there - showing you that you can use the Keptn to Dynatrace integration to let Keptn send events to any type of monitored service - not only those that are deployed by Keptn:</p>
<pre><code>---
spec_version: &#39;0.1.0&#39;
dtCreds: dynatrace
attachRules:
  tagRule:
  - meTypes:
    - SERVICE
    tags:
    - context: CONTEXTLESS
      key: $SERVICE
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Run Quality Gate through Keptn CLI" duration="2">
        <p>We should now have everything in place to let Keptn evaluate our quality gate. The only thing we need to do is ask Keptn to start an evaluation for our service and give it a timeframe. The easiest way to do this is by using the Keptn CLI using the command <a href="https://keptn.sh/docs/0.7.x/reference/cli/commands/keptn_send_event_start-evaluation/" target="_blank">keptn send event start-evaluation</a></p>
<ol type="1">
<li>Start the evaluation via the CLI</li>
</ol>
<p>The following is an example to have Keptn evaluate the last 10 minutes by also adding some labels which will later show up in the Keptns Bridge!</p>
<pre><code>keptn send event start-evaluation --project=qgproject --stage=qualitystage --service=evalservice --timeframe=10m --labels=gaterun=1,type=viacli
</code></pre>
<p>Please explore all other options in the Keptn CLI Documentation for <a href="https://keptn.sh/docs/0.7.x/reference/cli/commands/keptn_send_event_start-evaluation/" target="_blank">keptn send event start-evaluation</a>. You can also specify start and end timestamps or also combine start timestamp with a timeframe.</p>
<p>What will come back as an output is the Keptn Context. Something like:</p>
<pre><code>ID of Keptn context: f628eb68-849c-4e77-ab69-a504af34a081
</code></pre>
<ol type="1">
<li>Query status of the evaluation via the CLI</li>
</ol>
<p>As the evaluation is an asynchronous process it may take a while until the results are available. We can use that Keptn Context with a call <a href="https://keptn.sh/docs/0.7.x/reference/cli/commands/keptn_get_event_evaluation-done/" target="_blank">keptn get event evaluation-done</a> to query the status of our request by asking Keptn whether the event evaluation-done is already available for a specific Keptn context.</p>
<pre><code>keptn get event evaluation-done --keptn-context=f628eb68-849c-4e77-ab69-a504af34a081
</code></pre>
<p>While Keptn is still evaluation you will get a message that querying evaluation-done was not yet successful. Once the evalution is complete you will however receive the full evaluation result like this:</p>
<pre><code>{&#34;contenttype&#34;:&#34;application/json&#34;,&#34;data&#34;:{&#34;deploymentstrategy&#34;:&#34;&#34;,&#34;evaluationdetails&#34;:{&#34;indicatorResults&#34;:[{&#34;score&#34;:0,&#34;status&#34;:&#34;fail&#34;,&#34;targets&#34;:[{&#34;criteria&#34;:&#34;\u003c=800&#34;,&#34;targetValue&#34;:800,&#34;violated&#34;:true},{&#34;criteria&#34;:&#34;\u003c=+10%&#34;,&#34;targetValue&#34;:0,&#34;violated&#34;:false},{&#34;criteria&#34;:&#34;\u003c600&#34;,&#34;targetValue&#34;:600,&#34;violated&#34;:true}],&#34;value&#34;:{&#34;metric&#34;:&#34;rt_svc_p95&#34;,&#34;success&#34;:true,&#34;value&#34;:1153.0662}},{&#34;score&#34;:0,&#34;status&#34;:&#34;fail&#34;,&#34;targets&#34;:[{&#34;criteria&#34;:&#34;\u003e20000&#34;,&#34;targetValue&#34;:20000,&#34;violated&#34;:true}],&#34;value&#34;:{&#34;metric&#34;:&#34;throughput_svc&#34;,&#34;success&#34;:true,&#34;value&#34;:189}},{&#34;score&#34;:2,&#34;status&#34;:&#34;pass&#34;,&#34;targets&#34;:[{&#34;criteria&#34;:&#34;\u003c=1%&#34;,&#34;targetValue&#34;:1,&#34;violated&#34;:false}],&#34;value&#34;:{&#34;metric&#34;:&#34;error_rate_svc&#34;,&#34;success&#34;:true,&#34;value&#34;:0}},{&#34;score&#34;:0,&#34;status&#34;:&#34;info&#34;,&#34;targets&#34;:null,&#34;value&#34;:{&#34;metric&#34;:&#34;rt_svc_p50&#34;,&#34;success&#34;:true,&#34;value&#34;:0.404}},{&#34;score&#34;:0,&#34;status&#34;:&#34;fail&#34;,&#34;targets&#34;:[{&#34;criteria&#34;:&#34;\u003c=+10%&#34;,&#34;targetValue&#34;:0.7960919999999999,&#34;violated&#34;:true},{&#34;criteria&#34;:&#34;\u003c=+10%&#34;,&#34;targetValue&#34;:0.7960919999999999,&#34;violated&#34;:true}],&#34;value&#34;:{&#34;metric&#34;:&#34;rt_svc_p90&#34;,&#34;success&#34;:true,&#34;value&#34;:111.49150000000942}}],&#34;result&#34;:&#34;fail&#34;,&#34;score&#34;:40,&#34;sloFileContent&#34;:&#34;Y29tcGFyaXNvbjoKICBhZ2dyZWdhdGVfZnVuY3Rpb246IGF2ZwogIGNvbXBhcmVfd2l0aDogc2luZ2xlX3Jlc3VsdAogIGluY2x1ZGVfcmVzdWx0X3dpdGhfc2NvcmU6IHBhc3MKICBudW1iZXJfb2ZfY29tcGFyaXNvbl9yZXN1bHRzOiAzCmZpbHRlcjogbnVsbApvYmplY3RpdmVzOgotIGtleV9zbGk6IGZhbHNlCiAgcGFzczoKICAtIGNyaXRlcmlhOgogICAgLSA8PSsxMCUKICAgIC0gPDYwMAogIHNsaTogcnRfc3ZjX3A5NQogIHdhcm5pbmc6CiAgLSBjcml0ZXJpYToKICAgIC0gPD04MDAKICB3ZWlnaHQ6IDEKLSBrZXlfc2xpOiBmYWxzZQogIHBhc3M6CiAgLSBjcml0ZXJpYToKICAgIC0gJz4yMDAwMCcKICBzbGk6IHRocm91Z2hwdXRfc3ZjCiAgd2FybmluZzogbnVsbAogIHdlaWdodDogMQotIGtleV9zbGk6IGZhbHNlCiAgcGFzczoKICAtIGNyaXRlcmlhOgogICAgLSA8PTElCiAgc2xpOiBlcnJvcl9yYXRlX3N2YwogIHdhcm5pbmc6CiAgLSBjcml0ZXJpYToKICAgIC0gPD0yJQogIHdlaWdodDogMgotIGtleV9zbGk6IGZhbHNlCiAgcGFzczogbnVsbAogIHNsaTogcnRfc3ZjX3A1MAogIHdhcm5pbmc6IG51bGwKICB3ZWlnaHQ6IDEKLSBrZXlfc2xpOiBmYWxzZQogIHBhc3M6CiAgLSBjcml0ZXJpYToKICAgIC0gPD0rMTAlCiAgc2xpOiBydF9zdmNfcDkwCiAgd2FybmluZzoKICAtIGNyaXRlcmlhOgogICAgLSA8PSsxMCUKICB3ZWlnaHQ6IDEKc3BlY192ZXJzaW9uOiAwLjEuMAp0b3RhbF9zY29yZToKICBwYXNzOiA5MCUKICB3YXJuaW5nOiA3NSUK&#34;,&#34;timeEnd&#34;:&#34;2020-05-25T16:17:28.529Z&#34;,&#34;timeStart&#34;:&#34;2020-05-25T16:07:28.529Z&#34;},&#34;labels&#34;:{&#34;gaterun&#34;:&#34;1&#34;,&#34;type&#34;:&#34;viacli&#34;},&#34;project&#34;:&#34;qgproject&#34;,&#34;result&#34;:&#34;fail&#34;,&#34;service&#34;:&#34;evalservice&#34;,&#34;stage&#34;:&#34;qualitystage&#34;,&#34;teststrategy&#34;:&#34;manual&#34;},&#34;id&#34;:&#34;fa8f0c4b-4de7-4a0f-870f-175fdbcd6d33&#34;,&#34;source&#34;:&#34;lighthouse-service&#34;,&#34;specversion&#34;:&#34;0.2&#34;,&#34;time&#34;:&#34;2020-05-25T16:19:29.349Z&#34;,&#34;type&#34;:&#34;sh.keptn.events.evaluation-done&#34;,&#34;shkeptncontext&#34;:&#34;f628eb68-849c-4e77-ab69-a504af34a081&#34;}
</code></pre>
<ol type="1">
<li>Lets validate quality gate in bridge</li>
</ol>
<p>If everything works as expected we should be able to see the result in the Keptn&#39;s bridge</p>
<p class="image-container"><img src="img/cd903f1f68ababc3.png"></p>
<ol type="1">
<li>Lets evaluate the event in Dynatrace</li>
</ol>
<p>Thanks to the Dynatrace integration that also pushes events to Dynatrace we should also see Quality Gate result in Dynatrace when navigating to our sevice.</p>
<p class="image-container"><img src="img/9f15b21dbe01a546.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Run Quality Gate through Keptn API" duration="2">
        <p>After we have executed the Quality Gate Evaluation through the CLI lets do the same through the <a href="https://keptn.sh/docs/0.7.x/reference/api/" target="_blank">Keptn API</a>.<br>If you read through the <a href="https://keptn.sh/docs/0.7.x/reference/api/" target="_blank">Keptn API documentation</a> you learn we have to get the API Endpoint and the Token first!</p>
<ol type="1">
<li>Get API Endpoint</li>
</ol>
<p>Keptn status gives us the endpoint:</p>
<pre><code>$ keptn status
Starting to authenticate
Successfully authenticated
Using a file-based storage for the key because the password-store seems to be not set up.      
CLI is authenticated against the Keptn cluster https://YOURKEPTNDOMAIN/api
</code></pre>
<ol type="1">
<li>Retrieving API Token</li>
</ol>
<p>In order to retrieve the API token we need access to kubectl. There is an easy and convenient way described in the <a href="https://keptn.sh/docs/0.6.0/reference/cli/#authentication" target="_blank">Keptn CLI Authentication documentation</a> to actually retrieve and store both the API Endpoint and API Token in a variable. This helps us later on to automate API calls as well. So - lets do it!</p>
<pre><code>KEPTN_ENDPOINT=https://YOURKEPTNDOMAIN/api
KEPTN_API_TOKEN=$(kubectl get secret keptn-api-token -n keptn -ojsonpath={.data.keptn-api-token} | base64 --decode)
</code></pre>
<ol type="1">
<li>Explore the Keptn API via Swagger UI</li>
</ol>
<p>If you want to make yourself familiar with all options of the API you can browse to your api endpoint and explore the Swagger UI by adding /swagger-ui to the API Endpoint, e.g: https://YOURKEPTNDOMAIN/api/swagger-ui</p>
<ol type="1">
<li>Send a start-evaluation event</li>
</ol>
<p>The easiest way to make API calls is through the Swagger UI. In order to use it we first need to authorize the Swagger UI by giving it our API token. To get the actual value do:</p>
<pre><code>echo $KEPTN_API_TOKEN
</code></pre>
<p>Copy that value, navigate to your Swagger UI in your browser, make sure you have selected the <em>api-service</em> and then click Authorize. Now paste in your token and login!</p>
<p>Now we are ready to send a start-evaluation event just as we did before through the CLI. The only difference is that the API expects a start &amp; time timestamp and doesnt provide the convenient option of a timeframe. Thats why you have to make sure to put in timestamps where you know you have data in your Dynatrace environment. Here is my prepared POST body including the JSON object for start-evaluation:</p>
<pre><code>{
  &#34;type&#34;: &#34;sh.keptn.event.start-evaluation&#34;,
  &#34;source&#34;: &#34;https://github.com/keptn/keptn&#34;,
  &#34;data&#34;: {
    &#34;start&#34;: &#34;2020-05-27T07:00:00.000Z&#34;,
    &#34;end&#34;: &#34;2020-05-27T07:05:00.000Z&#34;,
    &#34;project&#34;: &#34;qgproject&#34;,
    &#34;stage&#34;: &#34;qualitystage&#34;,
    &#34;service&#34;: &#34;evalservice&#34;,
    &#34;teststrategy&#34;: &#34;manual&#34;
  }
}
</code></pre>
<p>Please take attention that the above CloudEvent contains the property <code>&#34;teststrategy&#34;: &#34;manual&#34;</code>. This is required to tell Keptn that we didn&#39;t use Keptn to execute any tests prior to the evaluation but that we just want to do a manual evaluation.</p>
<aside class="warning"><p>Please remember that the start and end time has to be changed to reflect the time frame you want to evaluate!</p>
</aside>
<p>In the Swagger UI scroll to the POST /event API call. Click on Try, then post the JSON body into the edit field like shown here:<br><img src="img/17be3b3e5077a79a.png"></p>
<p>The great thing about Swagger UI is that it will not only execute the request and give you the response. It will also give you the corresponding CURL command so you can easily integrate this API call into your automation scripts. The following shows the output including the response which includes the keptnContext ID of our triggered evaluation:<br><img src="img/e1b0a52f0b774002.png"></p>
<p>For your reference - here is the CURL command for easy copy/paste in case you want to execute this from your command line:</p>
<pre><code>curl -X POST &#34;$KEPTN_ENDPOINT/v1/event&#34; -H &#34;accept: application/json&#34; -H &#34;x-token: $KEPTN_API_TOKEN&#34; -H &#34;Content-Type: application/json&#34; -d &#34;{ \&#34;type\&#34;: \&#34;sh.keptn.event.start-evaluation\&#34;, \&#34;source\&#34;: \&#34;https://github.com/keptn/keptn\&#34;, \&#34;data\&#34;: { \&#34;start\&#34;: \&#34;2020-05-27T07:00:00.000Z\&#34;, \&#34;end\&#34;: \&#34;2020-05-27T07:05:00.000Z\&#34;, \&#34;project\&#34;: \&#34;qgproject\&#34;, \&#34;stage\&#34;: \&#34;qualitystage\&#34;, \&#34;service\&#34;: \&#34;evalservice\&#34;, \&#34;teststrategy\&#34;: \&#34;manual\&#34; }}&#34;
</code></pre>
<ol type="1">
<li>Query for evaluation-done</li>
</ol>
<p>Remember from when we ran through this excercise with the Keptn CLI? The evaluation may take up to a minute. In order to check whether the evaluation is done and what the result was we can now call the GET /events API endpoint and query the existence of an sh.keptn.events.evaluation-done event for the keptnContext we retrieved earlier:</p>
<p>You can execute this through the Swagger UI or - as it is rather simple and straight forward - using the following CURL:</p>
<pre><code>curl -X GET &#34;$KEPTN_ENDPOINT/v1/event?keptnContext=KEPTN_CONTEXT_ID&amp;type=sh.keptn.events.evaluation-done&#34; -k -H &#34;accept: application/json&#34; -H &#34;x-token: $KEPTN_API_TOKEN&#34;
</code></pre>
<p>The result comes in the form of the <code>evaluation-done</code> event, which is specified <a href="https://github.com/keptn/spec/blob/0.1.3/cloudevents.md#evaluation-done" target="_blank">here</a>.</p>
<p>Here the screenshot of the response in Swagger UI:<br><img src="img/5e37d823161a00c7.png"></p>
<ol type="1">
<li>Evaluate in Bridge &amp; Dynatrace</li>
</ol>
<p>Just as we did before you can also validate the data in the Keptn&#39;s Bridge as well as in Dynatrace!</p>


      </google-codelab-step>
    
      <google-codelab-step label="Finish" duration="0">
        <p>In this tutorial, you have learned how to use Keptn to validate the quality of your deployments by evaluating a set of SLIs (Service Level Indicators) against your SLOs (Service Level Objectives) for a specified timeframe! The overall goal is to use this capability to automate the manual evaluation of metrics through dashboards.</p>
<p>As you have now learned how to setup Keptn for pulling metrics out of Dynatrace the next step is that you do this with metrics that are important for your services, applications, processes and hosts. Think about how you can convert your Dynatrace dashboards into SLIs and SLOs and then have Keptn automate the analysis for you:</p>
<p class="image-container"><img src="img/7c651a5eb1b5f93a.gif"></p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Install Keptn and setup a Keptn Project for Quality Gate evaluation</li>
<li>Prepare Dynatrace to act as a data source for Quality Gate evaluation</li>
<li>Learn how to define and use service-level indicators (SLIs) and service-level objectives (SLOs)</li>
<li>How to trigger a Keptn Quality Gate evaluation using the CLI and the API</li>
<li>How to use the Keptns Bridge to inspect your Quality Gate Results</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Feedback" duration="0">
        <aside class="special"><p>We are happy to hear your feedback!</p>
</aside>
<p>Please visit us in our <a href="https://slack.keptn.sh" target="_blank">Keptn Slack</a> and tell us how you like Keptn and this tutorial! We are happy to hear your thoughts &amp; suggestions!</p>
<p>Also, make sure to <a href="https://twitter.com/keptnProject" target="_blank">follow us on Twitter</a> to get the latest news on Keptn, our tutorials and newest releases!</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
